<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Samba Voyage | Mon Espace Client</title>
    <style>
        :root { --samba-blue: #0070bb; --samba-bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--samba-bg); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-principal { background: var(--samba-blue); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; text-decoration: none; margin-left: 10px; }

        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer; border: 1px solid #e2e8f0; }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--samba-blue); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .card-sinistre { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; border-left: 5px solid #cbd5e1; }
        .card-sinistre.paye { border-left-color: #22c55e; }
        .card-sinistre.en-cours { border-left-color: #f59e0b; }

        .progress-track { display: flex; justify-content: space-between; margin-top: 20px; position: relative; }
        .step { flex: 1; text-align: center; font-size: 12px; color: #94a3b8; position: relative; }
        .step::before { content: ""; width: 20px; height: 20px; background: #e2e8f0; border-radius: 50%; display: block; margin: 0 auto 5px; }
        .step.active { color: var(--samba-blue); font-weight: bold; }
        .step.active::before { background: var(--samba-blue); }
        .step.completed { color: #22c55e; }
        .step.completed::before { background: #22c55e; content: "‚úì"; color: white; line-height: 20px; }

        .notif-paiement { background: #dcfce7; color: #166534; padding: 20px; border-radius: 12px; margin-bottom: 30px; display: none; border: 1px solid #22c55e; font-size: 16px; }

        /* --- AJOUT : STYLE DE LA FEUILLE DE CONTRAT --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .feuille-papier { background: white; width: 450px; padding: 40px; border-radius: 2px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: 'Courier New', monospace; position: relative; border-top: 8px solid var(--samba-blue); }
        .ligne-pointillee { border-bottom: 1px dotted #ccc; margin: 15px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="Logo Samba.jpeg" width="120">
        <div>
            <a href="contra-samba.html" class="btn-principal" style="background: #22c55e;">+ Nouvelle Souscription</a>
            <a href="declarer-sinistre.html" class="btn-principal">+ D√©clarer un Sinistre</a>
        </div>
    </div>

    <div id="notif-box" class="notif-paiement">
         <strong>Bonne nouvelle !</strong> Votre d√©dommagement a √©t√© valid√© et le virement a √©t√© effectu√© sur votre compte.
    </div>

    <div style="margin-bottom: 40px;">
        <h2>Mes Contrats Actifs</h2>
        <div id="liste-contrats-client" class="stats-grid">
            <p style="color: #64748b;">Chargement de vos contrats...</p>
        </div>
    </div>

    <h2>Mes D√©clarations (Suivi)</h2>
    <div id="liste-suivi">
        <p>Chargement de vos dossiers...</p>
    </div>
</div>

<div id="maFicheContrat" class="modal-overlay" onclick="this.style.display='none'">
    <div class="feuille-papier" onclick="event.stopPropagation()">
        <h3 style="text-align:center; text-decoration: underline;">CERTIFICAT D'ASSURANCE</h3>
        <p style="text-align:right; font-size:12px;">√âmis le : 17/02/2026</p>
        <div class="ligne-pointillee"><span>POLICE N¬∞:</span> <b id="fiche-id">---</b></div>
        <div class="ligne-pointillee"><span>COMPAGNIE:</span> <b>SAMBA ASSURANCES</b></div>
        <div class="ligne-pointillee"><span>ASSISTEUR:</span> <b>AFRICA FIRST ASSIST</b></div>
        <div class="ligne-pointillee"><span>ZONE:</span> <b>INTERNATIONAL</b></div>
        <div class="ligne-pointillee"><span>STATUT:</span> <b style="color:green;">VALIDE / PAY√â</b></div>
        
        <div style="margin-top:40px; font-size:11px; font-style:italic;">
            "Ce document confirme que le porteur b√©n√©ficie d'une couverture assistance voyage compl√®te g√©r√©e par AFA."
        </div>
        <button onclick="document.getElementById('maFicheContrat').style.display='none'" style="margin-top:30px; width:100%; padding:10px; cursor:pointer;">FERMER LE DOCUMENT</button>
    </div>
</div>

<script>
    // --- MODIFICATION : LA FONCTION OUVRE MAINTENANT LA FEUILLE ---
    function voirDetailsContrat(id) {
        document.getElementById('fiche-id').innerText = id;
        document.getElementById('maFicheContrat').style.display = 'flex';
    }

    async function chargerSuivi() {
        try {
            const res = await fetch('http://localhost:3000/api/liste-sinistres');
            const sinistres = await res.json();
            const container = document.getElementById('liste-suivi');
            container.innerHTML = '';

            sinistres.forEach(s => {
                const isPaye = s.statut_afa === 'D√âDOMMAG√â';
                if(isPaye) document.getElementById('notif-box').style.display = 'block';

                const card = `
                    <div class="card-sinistre ${isPaye ? 'paye' : 'en-cours'}">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>Dossier #SIN-${s.id}</strong>
                            <span>${s.type_incident}</span>
                        </div>
                        <div class="progress-track">
                            <div class="step completed">D√©clar√©</div>
                            <div class="step ${s.confirmation_samba ? 'completed' : 'active'}">Validation Samba</div>
                            <div class="step ${isPaye ? 'completed' : (s.confirmation_samba ? 'active' : '')}">D√©dommagement</div>
                        </div>
                        ${isPaye ? '<p style="color:#166534; margin-top:15px; font-weight:bold;">‚úÖ Paiement re√ßu</p>' : ''}
                    </div>
                `;
                container.innerHTML += card;
            });
        } catch (e) { console.error(e); }
    }

    async function chargerContratsClient() {
        try {
            const res = await fetch('http://localhost:3000/api/mes-contrats');
            const contrats = await res.json();
            const container = document.getElementById('liste-contrats-client');
            container.innerHTML = '';

            contrats.forEach(c => {
                container.innerHTML += `
                    <div class="stat-card" onclick="voirDetailsContrat('${c.numero_police}')" style="text-align: left; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--samba-blue); font-size: 18px;">${c.numero_police}</strong><br>
                            <small style="color: #64748b;">üìç Destination: ${c.destination} | üìÖ Expire le: ${new Date(c.date_echeance).toLocaleDateString()}</small>
                        </div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="background: #dcfce7; color: #166534; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold;">ACTIF</span>
                            <span style="color:#cbd5e1">‚ùØ</span>
                        </div>
                    </div>
                `;
            });
        } catch (e) { console.error(e); }
    }

    window.onload = () => {
        chargerSuivi();
        chargerContratsClient();
    };
    
    setInterval(chargerSuivi, 10000);
</script>

</body>
</html>