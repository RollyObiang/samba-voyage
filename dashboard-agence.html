<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>SAMB'A VOYAGE | Espace Agence</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root { 
        --samba-blue: #0070bb; 
        --samba-green: #39b54a; 
        --samba-bg: #f8fafc; 
        --sidebar-bg: #ffffff; 
    }
    
    body { font-family: 'Segoe UI', sans-serif; background: var(--samba-bg); margin: 0; display: flex; }
    
    /* Sidebar */
    .sidebar { 
        width: 260px; background: white; color: #334155; height: 100vh; 
        padding: 20px; position: fixed; border-right: 1px solid #e2e8f0; z-index: 10;
    }
    
    .menu-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; transition: 0.3s; color: #64748b; }
    .menu-item.active { background: var(--samba-blue); color: white; font-weight: bold; }
    .menu-item:hover:not(.active) { background: #f1f5f9; }

    .main-content { margin-left: 280px; padding: 30px; width: calc(100% - 320px); }
    
    .page-section { display: none; }
    .page-section.active { display: block; }

    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
    
    /* Animation et curseur pour les lignes cliquables */
    .stat-card-clickable { cursor: pointer; transition: 0.2s; }
    .stat-card-clickable:hover { background-color: #f8fafc !important; color: var(--samba-blue); }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 12px; }
    td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }

    /* Style de la Feuille de Contrat (Modale) */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; }
    .feuille-papier { background: white; width: 450px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: 'Courier New', monospace; border-top: 8px solid var(--samba-blue); position: relative; }
    .ligne-pointillee { border-bottom: 1px dotted #ccc; margin: 15px 0; display: flex; justify-content: space-between; }
</style>
</head>
<body>

  <div class="sidebar">
    <img src="Logo Samba.jpeg" width="150" style="margin-bottom: 20px;">
    <h3 id="nom-agence-display">Agent Samba</h3>
    <div class="menu-item active" onclick="changerPage('page-dashboard', this)"> Dashboard</div>
    <div class="menu-item" onclick="changerPage('page-emissions', this)"> Mes Émissions</div>
    <div class="menu-item" onclick="changerPage('page-clients', this)"> Mes Clients</div>
    <hr style="opacity: 0.1; margin: 20px 0;">
    <div class="menu-item" onclick="location.href='contra-samba.html'" style="color: #fbbf24; border: 1px solid #fbbf24; text-align:center;"> Nouvelle Police</div>
  </div>
  
  <div class="main-content">
    
    <div id="notif-afa-container" style="display:none; margin-bottom: 20px;">
        <div style="background: #fff7ed; border: 2px solid #ea580c; padding: 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between;">
            <div>
                <h4 style="margin: 0; color: #9a3412;">Alerte Africa First Assist</h4>
                <p style="margin: 5px 0 0 0; color: #c2410c;" id="notif-message">Chargement...</p>
            </div>
            <button id="btn-confirmer-samba" style="background: #ea580c; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">Confirmer</button>
        </div>
    </div>

    <div id="page-dashboard" class="page-section active">
        <h1>Dashboard Agence</h1>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px;">
            <div class="card" style="border-top:4px solid var(--samba-blue);">
                <h4>Ventes Réelles</h4>
                <p id="total-ca" style="font-size:24px; font-weight:bold;">0 FCFA</p>
            </div>
            <div class="card" style="border-top:4px solid var(--samba-green);">
                <h4>Polices Émises</h4>
                <p id="total-contrats" style="font-size:24px; font-weight:bold;">0</p>
            </div>
            <div class="card" style="border-top:4px solid orange;">
                <h4>Commissions (15%)</h4>
                <p id="total-com" style="font-size:24px; font-weight:bold;">0 FCFA</p>
            </div>
        </div>

        <div class="card">
            <h3>Dernières Émissions (Cliquer pour détails)</h3>
            <table>
                <thead>
                    <tr><th>N° Police</th><th>Assuré</th><th>Date</th><th>Destination</th><th>Statut</th></tr>
                </thead>
                <tbody id="liste-contrats-resume"></tbody>
            </table>
        </div>
    </div>

    <div id="page-emissions" class="page-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Historique des Émissions</h1>
            <input type="text" onkeyup="filtrerTableau('full-emissions-list', this.value)" placeholder="Rechercher police ou nom..." style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; width: 300px;">
        </div>
        <div class="card">
            <table>
                <thead>
                    <tr><th>Date</th><th>N° Police</th><th>Souscripteur</th><th>Destination</th><th>Montant</th></tr>
                </thead>
                <tbody id="full-emissions-list"></tbody>
            </table>
        </div>
    </div>

    <div id="page-clients" class="page-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Répertoire Clients</h1>
            <input type="text" onkeyup="filtrerTableau('clients-list', this.value)" placeholder="Filtrer par nom..." style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; width: 300px;">
        </div>
        <div class="card">
            <table>
                <thead>
                    <tr><th>Nom du Client</th><th>Dernière Destination</th><th>Nombre de Polices</th><th>Statut</th></tr>
                </thead>
                <tbody id="clients-list"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="maFicheContrat" class="modal-overlay" onclick="this.style.display='none'">
    <div class="feuille-papier" onclick="event.stopPropagation()">
        <h3 style="text-align:center; text-decoration: underline;">CERTIFICAT D'ASSURANCE</h3>
        <p style="text-align:right; font-size:12px;">Émis par : Samba Voyage</p>
        <div class="ligne-pointillee"><span>POLICE N°:</span> <b id="fiche-id">---</b></div>
        <div class="ligne-pointillee"><span>COMPAGNIE:</span> <b>SAMBA ASSURANCES</b></div>
        <div class="ligne-pointillee"><span>ASSISTEUR:</span> <b>AFRICA FIRST ASSIST</b></div>
        <div class="ligne-pointillee"><span>STATUT:</span> <b style="color:green;">VALIDE</b></div>
        <div style="margin-top:40px; font-size:11px; font-style:italic; border: 1px solid #eee; padding: 10px;">
            "Ce document atteste de la validité des garanties d'assistance voyage."
        </div>
        <button onclick="document.getElementById('maFicheContrat').style.display='none'" style="margin-top:30px; width:100%; padding:10px; cursor:pointer; background:#f1f5f9; border:1px solid #ccc;">FERMER</button>
    </div>
  </div>

  <script>
    let sinistreEnAttenteId = null;

    function changerPage(pageId, element) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        element.classList.add('active');
    }

    function voirDetailsContrat(id) {
        document.getElementById('fiche-id').innerText = id;
        document.getElementById('maFicheContrat').style.display = 'flex';
    }

    function filtrerTableau(idTableau, valeur) {
        const filtre = valeur.toLowerCase();
        const lignes = document.getElementById(idTableau).getElementsByTagName('tr');
        for (let i = 0; i < lignes.length; i++) {
            lignes[i].style.display = lignes[i].innerText.toLowerCase().includes(filtre) ? "" : "none";
        }
    }

    async function chargerDonneesDashboard() {
        try {
            const reponse = await fetch('http://localhost:3000/api/mes-contrats');
            const contrats = await reponse.json();
            
            const tbDash = document.getElementById('liste-contrats-resume');
            const tbEmis = document.getElementById('full-emissions-list');
            const tbClie = document.getElementById('clients-list');

            tbDash.innerHTML = ''; tbEmis.innerHTML = ''; tbClie.innerHTML = '';
            let totalCA = 0;

            contrats.forEach(c => {
                totalCA += 25000;
                const dateFmt = new Date(c.date_effet).toLocaleDateString();

                // 1. Remplissage Dashboard
                tbDash.innerHTML += `
                    <tr class="stat-card-clickable" onclick="voirDetailsContrat('${c.numero_police}')">
                        <td><strong>${c.numero_police}</strong></td>
                        <td>${c.souscripteur_nom}</td>
                        <td>${dateFmt}</td>
                        <td>${c.destination}</td>
                        <td><span class="status-badge" style="background:#dcfce7; color:#166534;">Actif</span></td>
                    </tr>`;

                // 2. Remplissage Mes Émissions (Ajout du clic ici)
                tbEmis.innerHTML += `
                    <tr class="stat-card-clickable" onclick="voirDetailsContrat('${c.numero_police}')">
                        <td>${dateFmt}</td>
                        <td>${c.numero_police}</td>
                        <td>${c.souscripteur_nom}</td>
                        <td>${c.destination}</td>
                        <td>25 000 FCFA</td>
                    </tr>`;

                // 3. Remplissage Mes Clients (Ajout du clic ici)
                tbClie.innerHTML += `
                    <tr class="stat-card-clickable" onclick="voirDetailsContrat('${c.numero_police}')">
                        <td><strong>${c.souscripteur_nom}</strong></td>
                        <td>${c.destination}</td>
                        <td>1</td>
                        <td><span style="color:green;">● Actif</span></td>
                    </tr>`;
            });

            document.getElementById('total-contrats').innerText = contrats.length;
            document.getElementById('total-ca').innerText = totalCA.toLocaleString() + " FCFA";
            document.getElementById('total-com').innerText = (totalCA * 0.15).toLocaleString() + " FCFA";
        } catch (e) { console.error(e); }
    }

    async function verifierDemandesAFA() {
        try {
            const res = await fetch('http://localhost:3000/api/liste-sinistres');
            const sinistres = await res.json();
            const demande = sinistres.find(s => s.statut_afa === 'ATTENTE_SAMBA' && !s.confirmation_samba);
            if (demande) {
                sinistreEnAttenteId = demande.id;
                document.getElementById('notif-message').innerText = `Confirmation requise : ${demande.nom_client} (#SIN-${demande.id})`;
                document.getElementById('notif-afa-container').style.display = 'block';
            } else {
                document.getElementById('notif-afa-container').style.display = 'none';
            }
        } catch (e) { console.error(e); }
    }

    document.getElementById('btn-confirmer-samba').onclick = async () => {
        if (!sinistreEnAttenteId) return;
        await fetch(`http://localhost:3000/api/valider-samba/${sinistreEnAttenteId}`, { method: 'PATCH' });
        alert("Validé !");
        chargerDonneesDashboard();
    };

    window.onload = () => {
        document.getElementById('nom-agence-display').innerText = localStorage.getItem('nomClientSamba') || 'Agent Samba';
        chargerDonneesDashboard();
        setInterval(verifierDemandesAFA, 5000);
    };
  </script>
</body>
</html>