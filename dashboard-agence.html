<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SAMB'A VOYAGE | Espace Agence</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root { 
        --samba-blue: #0070bb; 
        --samba-green: #39b54a; 
        --samba-bg: #f8fafc; 
        --sidebar-bg: #ffffff; 
    }
    
    body { font-family: 'Segoe UI', sans-serif; background: var(--samba-bg); margin: 0; display: flex; flex-direction: row; }
    
    /* Sidebar Adaptable */
    .sidebar { 
        width: 260px; background: white; color: #334155; height: 100vh; 
        padding: 20px; position: fixed; border-right: 1px solid #e2e8f0; z-index: 1000;
        transition: 0.3s;
    }
    
    .menu-item { padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; transition: 0.3s; color: #64748b; text-decoration: none; display: block; }
    .menu-item.active { background: var(--samba-blue); color: white; font-weight: bold; }
    .menu-item:hover:not(.active) { background: #f1f5f9; }

    /* Main Content Adaptable */
    .main-content { margin-left: 280px; padding: 30px; width: 100%; box-sizing: border-box; transition: 0.3s; }
    
    .page-section { display: none; }
    .page-section.active { display: block; }

    .card { 
        background: white; padding: 20px; border-radius: 12px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; 
        border: 1px solid #e2e8f0; overflow-x: auto; /* Scroll table mobile */
    }
    
    .stat-card-clickable { cursor: pointer; transition: 0.2s; }
    .stat-card-clickable:hover { background-color: #f8fafc !important; color: var(--samba-blue); }

    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; text-transform: uppercase; font-size: 11px; }
    td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 14px; }
    
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }

    /* Grille de stats adaptable */
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }

    /* Modale (Papier) Responsive */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
    .feuille-papier { background: white; width: 100%; max-width: 450px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: 'Courier New', monospace; border-top: 8px solid var(--samba-blue); position: relative; box-sizing: border-box; }
    .ligne-pointillee { border-bottom: 1px dotted #ccc; margin: 15px 0; display: flex; justify-content: space-between; flex-wrap: wrap; }

    /* --- RESPONSIVE --- */
    @media (max-width: 1024px) {
        body { flex-direction: column; }
        .sidebar { 
            width: 100%; height: auto; position: relative; border-right: none; 
            border-bottom: 1px solid #e2e8f0; padding: 10px; display: flex; 
            flex-direction: row; align-items: center; overflow-x: auto; gap: 10px;
        }
        .sidebar img { height: 40px; width: auto; margin-bottom: 0; }
        .sidebar h3 { display: none; } /* On cache le nom pour gagner de la place */
        .menu-item { margin-bottom: 0; white-space: nowrap; padding: 8px 15px; }
        .main-content { margin-left: 0; padding: 15px; }
    }

    @media (max-width: 480px) {
        .stats-container { grid-template-columns: 1fr; }
        h1 { font-size: 1.5rem; }
    }
</style>
</head>
<body>

  <div class="sidebar">
    <img src="Logo Samba.jpeg" width="150">
    <h3 id="nom-agence-display">Agent Samba</h3>
    <div class="menu-item active" onclick="changerPage('page-dashboard', this)"> Dashboard</div>
    <div class="menu-item" onclick="changerPage('page-emissions', this)"> Mes Émissions</div>
    <div class="menu-item" onclick="changerPage('page-clients', this)"> Mes Clients</div>
    <div class="menu-item" onclick="location.href='contra-samba.html'" style="color: #ea580c; font-weight: bold;">+ Nouvelle Police</div>
  </div>
  
  <div class="main-content">
    
    <div id="notif-afa-container" style="display:none; margin-bottom: 20px;">
        <div style="background: #fff7ed; border: 2px solid #ea580c; padding: 15px; border-radius: 12px; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px;">
            <div>
                <h4 style="margin: 0; color: #9a3412;">Alerte AFA</h4>
                <p style="margin: 5px 0 0 0; color: #c2410c; font-size: 14px;" id="notif-message">Chargement...</p>
            </div>
            <button id="btn-confirmer-samba" style="background: #ea580c; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer;">Confirmer</button>
        </div>
    </div>

    <div id="page-dashboard" class="page-section active">
        <h1>Dashboard Agence</h1>
        <div class="stats-container">
            <div class="card" style="border-top:4px solid var(--samba-blue);">
                <h4 style="margin-top:0; color:#64748b;">Ventes Réelles</h4>
                <p id="total-ca" style="font-size:24px; font-weight:bold; margin:10px 0 0 0;">0 FCFA</p>
            </div>
            <div class="card" style="border-top:4px solid var(--samba-green);">
                <h4 style="margin-top:0; color:#64748b;">Polices Émises</h4>
                <p id="total-contrats" style="font-size:24px; font-weight:bold; margin:10px 0 0 0;">0</p>
            </div>
            <div class="card" style="border-top:4px solid orange;">
                <h4 style="margin-top:0; color:#64748b;">Commissions (15%)</h4>
                <p id="total-com" style="font-size:24px; font-weight:bold; margin:10px 0 0 0;">0 FCFA</p>
            </div>
        </div>

        <div class="card">
            <h3>Dernières Émissions</h3>
            <table>
                <thead>
                    <tr><th>N° Police</th><th>Assuré</th><th>Date</th><th>Destination</th><th>Statut</th></tr>
                </thead>
                <tbody id="liste-contrats-resume"></tbody>
            </table>
        </div>
    </div>

    <div id="page-emissions" class="page-section">
        <h1>Historique</h1>
        <div class="card">
            <input type="text" onkeyup="filtrerTableau('full-emissions-list', this.value)" placeholder="Rechercher..." style="padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; width: 100%; margin-bottom: 15px; box-sizing: border-box;">
            <table>
                <thead>
                    <tr><th>Date</th><th>N° Police</th><th>Souscripteur</th><th>Destination</th><th>Montant</th></tr>
                </thead>
                <tbody id="full-emissions-list"></tbody>
            </table>
        </div>
    </div>

    <div id="page-clients" class="page-section">
        <h1>Répertoire Clients</h1>
        <div class="card">
            <table>
                <thead>
                    <tr><th>Nom du Client</th><th>Dernière Destination</th><th>Nombre</th><th>Statut</th></tr>
                </thead>
                <tbody id="clients-list"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="maFicheContrat" class="modal-overlay" onclick="this.style.display='none'">
    <div class="feuille-papier" onclick="event.stopPropagation()">
        <h3 style="text-align:center; text-decoration: underline;">CERTIFICAT D'ASSURANCE</h3>
        <div class="ligne-pointillee"><span>POLICE N°:</span> <b id="fiche-id">---</b></div>
        <div class="ligne-pointillee"><span>ASSISTEUR:</span> <b>AFRICA FIRST ASSIST</b></div>
        <div class="ligne-pointillee"><span>STATUT:</span> <b style="color:green;">VALIDE</b></div>
        <button onclick="document.getElementById('maFicheContrat').style.display='none'" style="margin-top:30px; width:100%; padding:12px; cursor:pointer; background:#f1f5f9; border:1px solid #ccc; font-weight: bold;">FERMER</button>
    </div>
  </div>

  <script>
    // Logique JS conservée (fetch, filtrage, pagination, notifs)
    let sinistreEnAttenteId = null;

    function changerPage(pageId, element) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        element.classList.add('active');
    }

    function voirDetailsContrat(id) {
        document.getElementById('fiche-id').innerText = id;
        document.getElementById('maFicheContrat').style.display = 'flex';
    }

    function filtrerTableau(idTableau, valeur) {
        const filtre = valeur.toLowerCase();
        const lignes = document.getElementById(idTableau).getElementsByTagName('tr');
        for (let i = 0; i < lignes.length; i++) {
            lignes[i].style.display = lignes[i].innerText.toLowerCase().includes(filtre) ? "" : "none";
        }
    }

    async function chargerDonneesDashboard() {
        try {
            const reponse = await fetch('http://localhost:3000/api/mes-contrats');
            if(!reponse.ok) throw new Error();
            const contrats = await reponse.json();
            
            const tbDash = document.getElementById('liste-contrats-resume');
            const tbEmis = document.getElementById('full-emissions-list');
            const tbClie = document.getElementById('clients-list');

            tbDash.innerHTML = ''; tbEmis.innerHTML = ''; tbClie.innerHTML = '';
            let totalCA = 0;

            contrats.forEach(c => {
                totalCA += 25000;
                const dateFmt = new Date(c.date_effet).toLocaleDateString();

                const row = `
                    <tr class="stat-card-clickable" onclick="voirDetailsContrat('${c.numero_police}')">
                        <td><strong>${c.numero_police}</strong></td>
                        <td>${c.souscripteur_nom}</td>
                        <td>${dateFmt}</td>
                        <td>${c.destination}</td>
                        <td><span class="status-badge" style="background:#dcfce7; color:#166534;">Actif</span></td>
                    </tr>`;
                
                tbDash.innerHTML += row;
                tbEmis.innerHTML += row; // Réutilisation simplifiée
                tbClie.innerHTML += `<tr onclick="voirDetailsContrat('${c.numero_police}')"><td>${c.souscripteur_nom}</td><td>${c.destination}</td><td>1</td><td>Actif</td></tr>`;
            });

            document.getElementById('total-contrats').innerText = contrats.length;
            document.getElementById('total-ca').innerText = totalCA.toLocaleString() + " FCFA";
            document.getElementById('total-com').innerText = (totalCA * 0.15).toLocaleString() + " FCFA";
        } catch (e) { console.log("Mode démo ou erreur API"); }
    }

    window.onload = () => {
        document.getElementById('nom-agence-display').innerText = localStorage.getItem('nomClientSamba') || 'Agent Samba';
        chargerDonneesDashboard();
    };
  </script>
</body>
</html>